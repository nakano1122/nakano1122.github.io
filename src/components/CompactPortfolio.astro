---
import { readFileSync } from 'fs';
import { join } from 'path';

// Markdown„Éï„Ç°„Ç§„É´„ÇíÁõ¥Êé•Ë™≠„ÅøËæº„Åø
const personalInfoPath = join(process.cwd(), 'src/data/personal-info.md');
const developmentExperiencePath = join(process.cwd(), 'src/data/development-experience.md');
const researchHistoryPath = join(process.cwd(), 'src/data/research-history.md');
const internshipHistoryPath = join(process.cwd(), 'src/data/internship-history.md');
const lastUpdatedPath = join(process.cwd(), 'src/data/last-updated.md');

const personalInfoContent = readFileSync(personalInfoPath, 'utf-8');
const developmentExperienceContent = readFileSync(developmentExperiencePath, 'utf-8');
const researchHistoryContent = readFileSync(researchHistoryPath, 'utf-8');
const internshipHistoryContent = readFileSync(internshipHistoryPath, 'utf-8');
const lastUpdatedContent = readFileSync(lastUpdatedPath, 'utf-8');

// Markdown„Åã„ÇâÂÄã‰∫∫ÊÉÖÂ†±„ÇíÊäΩÂá∫
function parsePersonalInfo(content: string) {
	const lines = content.split('\n');
	const personalData = {
		name: '',
		affiliation: '',
		grade: '',
		github: '',
		atcoder: '',
		toeic: 0
	};

	lines.forEach(line => {
		if (line.includes('**Ê∞èÂêç**:')) {
			personalData.name = line.replace('- **Ê∞èÂêç**:', '').trim();
		}
		if (line.includes('**ÊâÄÂ±û**:')) {
			personalData.affiliation = line.replace('- **ÊâÄÂ±û**:', '').trim();
		}
		if (line.includes('**Â≠¶Âπ¥**:')) {
			personalData.grade = line.replace('- **Â≠¶Âπ¥**:', '').trim();
		}
		if (line.includes('**GitHub**:')) {
			const match = line.match(/\[@(.*?)\]/);
			if (match) {
				personalData.github = match[1];
			}
		}
		if (line.includes('**AtCoder**:')) {
			const match = line.match(/\[@(.*?)\]/);
			if (match) {
				personalData.atcoder = match[1];
			}
		}
		if (line.includes('**TOEIC**:')) {
			const match = line.match(/(\d+)\s*ÁÇπ/);
			if (match) {
				personalData.toeic = parseInt(match[1]);
			}
		}
	});

	return personalData;
}

// ÈñãÁô∫ÁµåÈ®ì„Åã„ÇâÂèóË≥ûÊ≠¥„Å®ÊäÄË°ì„ÇíÊäΩÂá∫
function parseDevelopmentExperience(content: string) {
	const lines = content.split('\n');
	const awards = [];
	const technologies = [];
	
	let currentSection = '';
	
	lines.forEach(line => {
		if (line.includes('## ÂèóË≥ûÊ≠¥')) {
			currentSection = 'awards';
		} else if (line.includes('## ‰ΩøÁî®ÊäÄË°ì')) {
			currentSection = 'tech';
		} else if (line.includes('## ÂÄã‰∫∫ÈñãÁô∫')) {
			currentSection = 'projects';
		} else if (currentSection === 'awards' && line.includes('**') && line.includes('ÊúÄÂÑ™ÁßÄË≥û')) {
			const match = line.match(/\*\*(.*?)\*\*.*\((.*?)\)/);
			if (match) {
				awards.push({
					title: match[1],
					date: match[2]
				});
			}
		} else if (currentSection === 'tech' && line.includes('**') && line.includes(':')) {
			const match = line.match(/\*\*(.*?)\*\*:\s*(.*)/);
			if (match) {
				const techs = match[2].split(',').map(t => t.trim());
				technologies.push(...techs);
			}
		}
	});
	
	return { awards, technologies };
}

// Á†îÁ©∂Ê≠¥„Åã„ÇâË´ñÊñáÊï∞„ÇíÊäΩÂá∫
function parseResearchHistory(content: string) {
	const lines = content.split('\n');
	const publications = lines.filter(line => line.match(/^\d+\./)).length;
	return publications;
}

// „Ç§„É≥„Çø„Éº„É≥Ê≠¥„Åã„Çâ‰ºÅÊ•≠Êï∞„ÇíÊäΩÂá∫
function parseInternshipHistory(content: string) {
	const lines = content.split('\n');
	const companies = lines.filter(line => line.match(/^## \d+\./)).length;
	return companies;
}

// Êõ¥Êñ∞Êó•„ÇíÊäΩÂá∫
function parseLastUpdated(content: string) {
	const lines = content.split('\n');
	let lastUpdated = '';
	
	lines.forEach(line => {
		if (line.includes('ÊúÄÁµÇÊõ¥Êñ∞Êó•:')) {
			lastUpdated = line.replace('ÊúÄÁµÇÊõ¥Êñ∞Êó•:', '').trim();
		}
	});
	
	return lastUpdated || '2024Âπ¥7Êúà28Êó•';
}

// „Éá„Éº„Çø„ÇíËß£Êûê
const personalData = parsePersonalInfo(personalInfoContent);
const { awards, technologies } = parseDevelopmentExperience(developmentExperienceContent);
const publicationCount = parseResearchHistory(researchHistoryContent);
const companyCount = parseInternshipHistory(internshipHistoryContent);
const lastUpdated = parseLastUpdated(lastUpdatedContent);

// Áµ±Ë®à„Éá„Éº„Çø„ÇíÁîüÊàê
const quickStats = [
	{ label: "Ë´ñÊñáÁô∫Ë°®", value: publicationCount.toString() },
	{ label: "„Ç§„É≥„Çø„Éº„É≥", value: `${companyCount}Á§æ` },
	{ label: "ÂèóË≥û", value: `${awards.length}Âõû` },
	{ label: "TOEIC", value: `${personalData.toeic}ÁÇπ` }
];

// „Éè„Ç§„É©„Ç§„Éà„ÇíÁîüÊàê
const highlights = [
	...awards.slice(0, 2).map(award => ({
		title: award.title,
		date: award.date,
		type: "award"
	})),
	{
		title: `${personalData.affiliation} ${personalData.grade}`,
		date: "ÁèæÂú®",
		type: "education"
	}
];
---

<main class="portfolio-container">
	<!-- Hero Section -->
	<section class="hero-section">
		<div class="hero-content">
			<div class="avatar">
				<span class="avatar-initial">{personalData.name.charAt(0)}</span>
			</div>
			<div class="hero-text">
				<h1 class="hero-name">{personalData.name}</h1>
				<p class="hero-title">Software Engineer & Researcher</p>
				<p class="hero-affiliation">{personalData.affiliation} {personalData.grade}</p>
			</div>
		</div>
	</section>

	<!-- Main Content Grid -->
	<div class="content-grid">
		<!-- Stats Section -->
		<section class="stats-card">
			<h2 class="card-title">ÂÆüÁ∏æ</h2>
			<div class="stats-grid">
				{quickStats.map((stat) => (
					<div class="stat-item">
						<div class="stat-value">{stat.value}</div>
						<div class="stat-label">{stat.label}</div>
					</div>
				))}
			</div>
		</section>

		<!-- Skills Section -->
		<section class="skills-card">
			<h2 class="card-title">‰∏ªË¶ÅÊäÄË°ì</h2>
			<div class="tech-list">
				{technologies.slice(0, 6).map((tech) => (
					<span class="tech-tag">{tech}</span>
				))}
			</div>
			<a href="/development#technologies" class="view-more">„Åô„Åπ„Å¶Ë¶ã„Çã ‚Üí</a>
		</section>

		<!-- Recent Highlights -->
		<section class="highlights-card">
			<h2 class="card-title">ÊúÄËøë„ÅÆ„Éè„Ç§„É©„Ç§„Éà</h2>
			<div class="highlights-list">
				{highlights.map((highlight) => (
					<div class="highlight-item">
						<div class="highlight-content">
							<h3 class="highlight-title">{highlight.title}</h3>
							<span class="highlight-date">{highlight.date}</span>
						</div>
						<span class={`highlight-type highlight-type-${highlight.type}`}>
							{highlight.type === 'award' ? 'üèÜ' : 
							 highlight.type === 'experience' ? 'üíº' : 
							 highlight.type === 'research' ? 'üìö' : 
							 highlight.type === 'education' ? 'üéì' : 'üìÑ'}
						</span>
					</div>
				))}
			</div>
		</section>

		<!-- Personal Info Section -->
		<section class="personal-info-card">
			<h2 class="card-title">ÂÄã‰∫∫ÊÉÖÂ†±</h2>
			<div class="personal-info">
				<div class="info-item">
					<span class="info-label">GitHub:</span>
					<a href={`https://github.com/${personalData.github}`} class="info-link" target="_blank" rel="noopener noreferrer">@{personalData.github}</a>
				</div>
				<div class="info-item">
					<span class="info-label">AtCoder:</span>
					<a href={`https://atcoder.jp/users/${personalData.atcoder}`} class="info-link" target="_blank" rel="noopener noreferrer">@{personalData.atcoder}</a>
				</div>
				<div class="info-item">
					<span class="info-label">TOEIC:</span>
					<span class="info-value">{personalData.toeic}ÁÇπ</span>
				</div>
			</div>
		</section>
	</div>

	<!-- Footer -->
	<footer class="portfolio-footer">
		<p class="last-updated">ÊúÄÁµÇÊõ¥Êñ∞Êó•: {lastUpdated}</p>
	</footer>
</main>

<style>
	.portfolio-container {
		max-width: 1400px;
		margin: 0 auto;
		padding: var(--spacing-xl);
		font-family: 'Inter', 'Noto Sans JP', sans-serif;
		min-height: 100vh;
		display: flex;
		flex-direction: column;
	}

	/* Hero Section */
	.hero-section {
		text-align: center;
		margin-bottom: var(--spacing-4xl);
		padding: var(--spacing-3xl) 0;
		position: relative;
	}

	.hero-content {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: var(--spacing-xl);
	}

	.avatar {
		width: 64px;
		height: 64px;
		background: var(--color-primary);
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		color: white;
		font-weight: 600;
		font-size: 1.5rem;
	}

	.hero-name {
		font-size: 2.5rem;
		font-weight: 700;
		color: var(--color-text);
		margin-bottom: var(--spacing-sm);
		background: var(--gradient-primary);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		background-clip: text;
	}

	.hero-title {
		font-size: 1.25rem;
		color: var(--color-primary-solid);
		font-weight: 500;
		margin-bottom: var(--spacing-sm);
	}

	.hero-affiliation {
		font-size: 1rem;
		color: var(--color-text-light);
	}


	/* Content Grid */
	.content-grid {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: var(--spacing-xl);
		flex: 1;
		align-content: start;
	}

	.stats-card,
	.skills-card,
	.highlights-card,
	.personal-info-card {
		background: var(--color-bg-card);
		border: 1px solid var(--color-border);
		border-radius: var(--radius-lg);
		padding: var(--spacing-xl);
		box-shadow: var(--shadow-sm);
		transition: box-shadow 0.2s ease;
	}

	.stats-card:hover,
	.skills-card:hover,
	.highlights-card:hover,
	.personal-info-card:hover {
		box-shadow: var(--shadow-md);
	}

	.card-title {
		font-size: 1.125rem;
		font-weight: 600;
		color: var(--color-text);
		margin-bottom: var(--spacing-lg);
		position: relative;
		padding-left: var(--spacing-md);
	}

	.card-title::before {
		content: '';
		position: absolute;
		left: 0;
		top: 50%;
		transform: translateY(-50%);
		width: 3px;
		height: 16px;
		background: var(--color-primary);
		border-radius: 2px;
	}

	/* Stats */
	.stats-grid {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: var(--spacing-lg);
	}

	.stat-item {
		text-align: center;
	}

	.stat-value {
		font-size: 2rem;
		font-weight: 700;
		color: var(--color-primary);
		margin-bottom: var(--spacing-xs);
	}

	.stat-label {
		font-size: 0.875rem;
		color: var(--color-text-light);
	}

	/* Skills */
	.tech-list {
		display: flex;
		flex-wrap: wrap;
		gap: var(--spacing-sm);
		margin-bottom: var(--spacing-lg);
	}

	.tech-tag {
		background: var(--color-bg-secondary);
		color: var(--color-text);
		padding: var(--spacing-xs) var(--spacing-sm);
		border-radius: var(--radius-sm);
		font-size: 0.875rem;
		font-weight: 500;
		border: 1px solid var(--color-border);
	}

	.view-more {
		color: var(--color-primary);
		text-decoration: none;
		font-size: 0.875rem;
		font-weight: 500;
	}

	/* Highlights */
	.highlights-list {
		display: flex;
		flex-direction: column;
		gap: var(--spacing-md);
	}

	.highlight-item {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: var(--spacing-md);
		background: var(--color-bg-secondary);
		border-radius: var(--radius-md);
	}

	.highlight-title {
		font-size: 0.875rem;
		font-weight: 500;
		color: var(--color-text);
		margin-bottom: var(--spacing-xs);
	}

	.highlight-date {
		font-size: 0.75rem;
		color: var(--color-text-lighter);
	}

	.highlight-type {
		font-size: 1.25rem;
	}

	/* Personal Info */
	.personal-info {
		display: flex;
		flex-direction: column;
		gap: var(--spacing-md);
	}

	.info-item {
		display: flex;
		align-items: center;
		gap: var(--spacing-sm);
		padding: var(--spacing-sm);
		border-radius: var(--radius-md);
	}

	.info-label {
		font-weight: 500;
		color: var(--color-text);
		min-width: 80px;
	}

	.info-link {
		color: var(--color-primary);
		text-decoration: none;
		transition: color 0.2s ease;
	}

	.info-link:hover {
		color: var(--color-primary-dark);
	}

	.info-value {
		color: var(--color-text-light);
	}

	/* Footer */
	.portfolio-footer {
		margin-top: var(--spacing-2xl);
		padding-top: var(--spacing-lg);
		border-top: 1px solid var(--color-border);
		text-align: center;
	}

	.last-updated {
		font-size: 0.875rem;
		color: var(--color-text-lighter);
	}

	/* Responsive */
	@media (max-width: 768px) {
		.portfolio-container {
			padding: var(--spacing-lg);
		}

		.hero-name {
			font-size: 2rem;
		}

		.hero-title {
			font-size: 1.125rem;
		}

		.hero-affiliation {
			font-size: 0.875rem;
		}

		.content-grid {
			grid-template-columns: 1fr;
			gap: var(--spacing-lg);
		}

		.stats-grid {
			grid-template-columns: repeat(4, 1fr);
			gap: var(--spacing-sm);
		}

		.stat-value {
			font-size: 1.5rem;
		}

		.stat-label {
			font-size: 0.75rem;
		}
	}
</style>