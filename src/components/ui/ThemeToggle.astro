---
/**
 * テーマ切り替えボタンコンポーネント
 */
---

<button
	class="theme-toggle"
	type="button"
	aria-label="テーマを切り替える"
	title="テーマを切り替える"
>
	<img data-toggle-icon="sun" alt="" class="toggle-icon sun-icon" />
	<img data-toggle-icon="moon" alt="" class="toggle-icon moon-icon" />
</button>

<script>
	function initTheme() {
		const toggle = document.querySelector('.theme-toggle');
		if (!toggle) return;

		// 保存されたテーマまたはシステム設定を取得
		const getPreferredTheme = (): 'light' | 'dark' => {
			const stored = localStorage.getItem('theme');
			if (stored === 'light' || stored === 'dark') return stored;
			return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
		};

		// テーマに応じたアイコンパスを更新
		const updateThemeIcons = (theme: 'light' | 'dark') => {
			// テーマ切り替えボタンのアイコン
			document.querySelectorAll<HTMLImageElement>('[data-toggle-icon]').forEach((img) => {
				const iconName = img.dataset.toggleIcon;
				if (iconName) {
					img.src = `/images/${theme}/${iconName}.svg`;
				}
			});

			// 全てのテーマ対応アイコン
			document.querySelectorAll<HTMLImageElement>('[data-theme-icon]').forEach((img) => {
				const iconName = img.dataset.themeIcon;
				if (iconName) {
					img.src = `/images/${theme}/${iconName}.svg`;
				}
			});
		};

		// テーマを適用
		const applyTheme = (theme: 'light' | 'dark') => {
			document.documentElement.setAttribute('data-theme', theme);
			localStorage.setItem('theme', theme);
			updateThemeIcons(theme);
		};

		// 初期テーマを適用
		applyTheme(getPreferredTheme());

		// トグルボタンのクリックイベント
		toggle.addEventListener('click', () => {
			const current = document.documentElement.getAttribute('data-theme');
			const next = current === 'dark' ? 'light' : 'dark';
			applyTheme(next);
		});

		// システム設定の変更を監視
		window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
			if (!localStorage.getItem('theme')) {
				applyTheme(e.matches ? 'dark' : 'light');
			}
		});
	}

	// ページ読み込み時とViewTransition後に初期化
	initTheme();
	document.addEventListener('astro:after-swap', initTheme);
</script>

<style>
	.theme-toggle {
		position: fixed;
		top: var(--space-lg);
		right: var(--space-lg);
		width: 44px;
		height: 44px;
		display: flex;
		align-items: center;
		justify-content: center;
		background: var(--color-bg-card);
		border: 1px solid var(--color-border);
		border-radius: 50%;
		cursor: pointer;
		transition: all var(--transition-base);
		box-shadow: var(--shadow-sm);
		z-index: 100;
	}

	.theme-toggle:hover {
		background: var(--color-bg-card-hover);
		border-color: var(--color-accent);
		transform: scale(1.05);
		box-shadow: var(--shadow-md);
	}

	.toggle-icon {
		width: 20px;
		height: 20px;
		transition: opacity var(--transition-fast), transform var(--transition-fast);
		position: absolute;
	}

	/* ライトモード: 月アイコンを表示 */
	.sun-icon {
		opacity: 0;
		transform: rotate(-90deg) scale(0.5);
	}

	.moon-icon {
		opacity: 1;
		transform: rotate(0) scale(1);
	}

	/* ダークモード: 太陽アイコンを表示 */
	:global([data-theme='dark']) .sun-icon {
		opacity: 1;
		transform: rotate(0) scale(1);
	}

	:global([data-theme='dark']) .moon-icon {
		opacity: 0;
		transform: rotate(90deg) scale(0.5);
	}

	@media (max-width: 768px) {
		.theme-toggle {
			top: var(--space-md);
			right: var(--space-md);
			width: 40px;
			height: 40px;
		}

		.toggle-icon {
			width: 18px;
			height: 18px;
		}
	}
</style>
